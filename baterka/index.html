<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battery Health Report (AVILOO Style)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #0056b3; --success: #28a745; --danger: #dc3545; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 12px; }
        
        h1, h2 { color: #2c3e50; margin-bottom: 10px; }
        .header { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 30px; }
        .header p { color: #666; }

        .upload-section { text-align: center; padding: 40px; border: 2px dashed #ccc; border-radius: 8px; background: #fafafa; cursor: pointer; transition: 0.3s; }
        .upload-section:hover { border-color: var(--primary); background: #eef5ff; }
        input[type="file"] { display: none; }
        .btn { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }

        /* Dashboard Grid */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .card { padding: 20px; background: #fff; border: 1px solid #eee; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-value { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .card-label { color: #777; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; }
        
        .good { color: var(--success); }
        .bad { color: var(--danger); }

        .charts-section { margin-top: 40px; }
        .chart-container { position: relative; height: 350px; margin-bottom: 50px; border: 1px solid #f0f0f0; padding: 15px; border-radius: 8px; }
        
        #report { display: none; }
        .footer { text-align: center; margin-top: 50px; color: #aaa; font-size: 0.8em; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>DiagnostickÃ½ Report Baterie</h1>
        <p>AnalÃ½za dat z aplikace Car Scanner (AVILOO styl)</p>
    </div>

    <div class="upload-section" onclick="document.getElementById('csvFile').click()">
        <h2>ğŸ“‚ NahrÃ¡t CSV soubor</h2>
        <p>KliknÄ›te sem a vyberte exportovanÃ½ soubor z Car Scanneru (.csv)</p>
        <input type="file" id="csvFile" accept=".csv">
    </div>

    <div id="report">
        <hr style="margin: 40px 0; border: 0; border-top: 1px solid #eee;">
        
        <h2>ğŸ“Š VÃ½sledek Testu</h2>
        <div class="dashboard">
            <div class="card">
                <div class="card-label">State of Health (SoH)</div>
                <div class="card-value" id="sohValue">-- %</div>
                <div id="sohComment" style="font-size: 0.9em;">NaÄÃ­tÃ¡nÃ­...</div>
            </div>
            <div class="card">
                <div class="card-label">Max. RozdÃ­l NapÄ›tÃ­ (Delta)</div>
                <div class="card-value" id="deltaValue">-- mV</div>
                <div style="font-size: 0.9em;">ÄŒÃ­m mÃ©nÄ›, tÃ­m lÃ©pe</div>
            </div>
            <div class="card">
                <div class="card-label">TestovanÃ¡ Kapacita</div>
                <div class="card-value" id="socRange">-- %</div>
                <div style="font-size: 0.9em;">Rozsah SoC bÄ›hem testu</div>
            </div>
        </div>

        <div class="charts-section">
            <h2>ğŸ“‰ PrÅ¯bÄ›h NapÄ›tÃ­ ÄŒlÃ¡nkÅ¯ (Min/Max)</h2>
            <p style="color:#666; font-size: 0.9em;">Tento graf ukazuje, jak se chovaly nejslabÅ¡Ã­ a nejsilnÄ›jÅ¡Ã­ ÄlÃ¡nky bÄ›hem jÃ­zdy/nabÃ­jenÃ­. VelkÃ½ rozestup (Å¡edÃ¡ zÃ³na) znaÄÃ­ problÃ©m.</p>
            <div class="chart-container">
                <canvas id="voltageChart"></canvas>
            </div>

            <h2>ğŸŒ¡ï¸ Teplota Baterie</h2>
            <div class="chart-container">
                <canvas id="tempChart"></canvas>
            </div>

            <h2>ğŸ”‹ Detail ÄŒlÃ¡nkÅ¯ (Snapshot pÅ™i Max Delta)</h2>
            <p style="color:#666; font-size: 0.9em;">NapÄ›tÃ­ vÅ¡ech ÄlÃ¡nkÅ¯ v okamÅ¾iku, kdy byla baterie nejvÃ­ce "rozhozenÃ¡".</p>
            <div class="chart-container">
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="footer">
        Generated by AI Assistant based on Car Scanner Data
    </div>
</div>

<script>
    // Konfigurace PIDÅ¯ (klÃ­Äe, kterÃ© hledÃ¡me v CSV)
    const PIDS = {
        SOH: '[BMS] State of Health',
        SOC: '[BMS] State of Charge BMS', // PÅ™Ã­padnÄ› '[BMS] State of Charge Display'
        CURRENT: '[BMS] Battery Current',
        VOLT_TOTAL: '[BMS] Battery DC Voltage',
        TEMP_MIN: '[BMS] Battery Min Temperature',
        TEMP_MAX: '[BMS] Battery Max Temperature',
        // Cell voltages budeme generovat dynamicky
    };

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // ZmÄ›na UI
        document.querySelector('.upload-section').innerHTML = '<h2>â³ ZpracovÃ¡vÃ¡m data...</h2>';

        Papa.parse(file, {
            delimiter: ";", // Car Scanner pouÅ¾Ã­vÃ¡ stÅ™ednÃ­k
            header: true,
            dynamicTyping: true, // PÅ™evede ÄÃ­sla na Number
            skipEmptyLines: true,
            complete: function(results) {
                try {
                    processData(results.data);
                } catch (err) {
                    alert("Chyba pÅ™i zpracovÃ¡nÃ­: " + err.message);
                    console.error(err);
                }
            }
        });
    });

    function processData(rawData) {
        // 1. TRANSFORMACE DAT (Long to Wide + Forward Fill)
        // Data jsou "rozsypanÃ¡" (kaÅ¾dÃ½ Å™Ã¡dek jinÃ½ PID). MusÃ­me je srovnat podle Äasu.
        
        let timeMap = new Map(); // Key: Math.floor(Seconds), Value: Object s daty
        let lastValues = {};     // Pamatuje si poslednÃ­ znÃ¡mou hodnotu pro kaÅ¾dÃ½ PID
        
        // SeÅ™adÃ­me pro jistotu podle Äasu
        rawData.sort((a, b) => a.SECONDS - b.SECONDS);

        rawData.forEach(row => {
            const timeKey = Math.floor(row.SECONDS); // Seskupujeme po 1 sekundÄ›
            
            // Aktualizujeme poslednÃ­ znÃ¡mou hodnotu pro danÃ½ PID
            lastValues[row.PID] = row.VALUE;

            // UloÅ¾Ã­me snapshot "aktuÃ¡lnÃ­ho stavu vÅ¡ech senzorÅ¯" pro tuto sekundu
            // PouÅ¾Ã­vÃ¡me kopii objektu lastValues
            timeMap.set(timeKey, { ...lastValues, time: timeKey });
        });

        const timeline = Array.from(timeMap.values());
        
        if (timeline.length === 0) {
            alert("CSV neobsahuje platnÃ¡ data nebo mÃ¡ Å¡patnÃ½ formÃ¡t.");
            return;
        }

        // 2. ANALÃZA
        let maxDelta = 0;
        let maxDeltaIndex = 0;
        let sohValues = [];
        let startSoc = null;
        let endSoc = null;

        // PÅ™ipravÃ­me pole pro grafy
        const labels = [];
        const minVolts = [];
        const maxVolts = [];
        const avgVolts = [];
        const batteryTemps = [];

        timeline.forEach((point, index) => {
            // Najdeme napÄ›tÃ­ vÅ¡ech ÄlÃ¡nkÅ¯ v tomto bodÄ›
            let cells = [];
            for (let i = 1; i <= 98; i++) {
                let pidKey = `[BMS] Cell Voltage ${i.toString().padStart(2, '0')}`;
                if (point[pidKey] !== undefined) {
                    cells.push(point[pidKey]);
                }
            }

            if (cells.length > 0) {
                const min = Math.min(...cells);
                const max = Math.max(...cells);
                const avg = cells.reduce((a, b) => a + b, 0) / cells.length;
                const delta = max - min;

                if (delta > maxDelta) {
                    maxDelta = delta;
                    maxDeltaIndex = index;
                }

                labels.push(new Date(point.time * 1000).toISOString().substr(11, 8)); // ÄŒas HH:MM:SS
                minVolts.push(min);
                maxVolts.push(max);
                avgVolts.push(avg);
            } else {
                // Pokud vteÅ™ina nemÃ¡ data o ÄlÃ¡ncÃ­ch, zkusÃ­me zachovat kontinuitu nebo null
                labels.push(""); 
                minVolts.push(null);
                maxVolts.push(null);
            }

            // Teploty a SoH
            if (point[PIDS.TEMP_MAX]) batteryTemps.push(point[PIDS.TEMP_MAX]);
            if (point[PIDS.SOH]) sohValues.push(point[PIDS.SOH]);
            
            // SoC rozsah
            let soc = point[PIDS.SOC];
            if (soc !== undefined) {
                if (startSoc === null) startSoc = soc;
                endSoc = soc;
            }
        });

        // 3. VYKRESLENÃ UI
        document.querySelector('.upload-section').style.display = 'none';
        document.getElementById('report').style.display = 'block';

        // Karty
        const finalSoH = sohValues.length > 0 ? sohValues[sohValues.length-1] : "N/A";
        const sohEl = document.getElementById('sohValue');
        sohEl.innerText = finalSoH + (typeof finalSoH === 'number' ? " %" : "");
        sohEl.className = "card-value " + (finalSoH > 90 ? "good" : (finalSoH < 75 ? "bad" : ""));
        
        const deltaMv = (maxDelta * 1000).toFixed(1);
        const deltaEl = document.getElementById('deltaValue');
        deltaEl.innerText = deltaMv + " mV";
        deltaEl.className = "card-value " + (deltaMv < 20 ? "good" : (deltaMv > 50 ? "bad" : ""));

        document.getElementById('socRange').innerText = `${startSoc}% -> ${endSoc}%`;

        // 4. GRAFY
        
        // Graf 1: Min/Max NapÄ›tÃ­
        new Chart(document.getElementById('voltageChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Max NapÄ›tÃ­ ÄŒlÃ¡nku (V)',
                        data: maxVolts,
                        borderColor: '#dc3545', // ÄŒervenÃ¡
                        borderWidth: 1,
                        pointRadius: 0,
                        fill: false
                    },
                    {
                        label: 'Min NapÄ›tÃ­ ÄŒlÃ¡nku (V)',
                        data: minVolts,
                        borderColor: '#0056b3', // ModrÃ¡
                        borderWidth: 1,
                        pointRadius: 0,
                        fill: '-1', // Vyplnit prostor mezi min a max
                        backgroundColor: 'rgba(0, 86, 179, 0.1)'
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                scales: { y: { title: { display: true, text: 'NapÄ›tÃ­ (V)' } } }
            }
        });

        // Graf 2: Teplota
        new Chart(document.getElementById('tempChart'), {
            type: 'line',
            data: {
                labels: labels, // PouÅ¾ijeme stejnou osu, i kdyÅ¾ mÅ¯Å¾e bÃ½t mÃ©nÄ› bodÅ¯ (Chart.js si poradÃ­)
                datasets: [{
                    label: 'Max Teplota Baterie (Â°C)',
                    data: batteryTemps,
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.2)',
                    fill: true,
                    pointRadius: 0
                }]
            }
        });

        // Graf 3: Snapshot detailu ÄlÃ¡nkÅ¯ v nejhorÅ¡Ã­m bodÄ›
        const worstMoment = timeline[maxDeltaIndex];
        const cellLabels = [];
        const cellValues = [];
        
        for (let i = 1; i <= 98; i++) {
            let key = `[BMS] Cell Voltage ${i.toString().padStart(2, '0')}`;
            if (worstMoment[key]) {
                cellLabels.push(i);
                cellValues.push(worstMoment[key]);
            }
        }

        // ObarvenÃ­ sloupce s min a max hodnotou
        const minVal = Math.min(...cellValues);
        const bgColors = cellValues.map(v => v === minVal ? '#dc3545' : '#0056b3');

        new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: {
                labels: cellLabels,
                datasets: [{
                    label: 'NapÄ›tÃ­ (V)',
                    data: cellValues,
                    backgroundColor: bgColors
                }]
            },
            options: {
                responsive: true,
                scales: { 
                    y: { 
                        min: minVal - 0.05, // Zoom na relevantnÃ­ ÄÃ¡st
                        title: { display: true, text: 'NapÄ›tÃ­ (V)' } 
                    } 
                },
                plugins: {
                    title: { display: true, text: `DetailnÃ­ pohled v Äase ${new Date(worstMoment.time * 1000).toISOString().substr(11,8)}` }
                }
            }
        });
    }
</script>

</body>
</html>