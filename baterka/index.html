<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battery Health Report (Car Scanner)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .report-card { background: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 0.5rem; }
        .gauge-circle {
            width: 150px; height: 150px; border-radius: 50%;
            background: conic-gradient(#22c55e 0% 94%, #e5e7eb 94% 100%);
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .gauge-inner {
            width: 120px; height: 120px; background: white; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .hidden { display: none; }
    </style>
</head>
<body class="p-8">

    <div id="uploadSection" class="max-w-2xl mx-auto bg-white p-10 rounded-xl shadow-lg text-center mt-10">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Generátor Reportu Baterie</h1>
        <p class="text-gray-500 mb-6">Nahrajte CSV soubor z aplikace Car Scanner (formát ;)</p>
        
        <label class="block mb-2 text-sm font-medium text-gray-900" for="file_input">Vybrat soubor</label>
        <input class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none p-2" 
               id="file_input" type="file" accept=".csv">
        
        <div id="loading" class="hidden mt-4 text-blue-600 font-semibold">Zpracovávám data...</div>
    </div>

    <div id="reportSection" class="hidden max-w-5xl mx-auto space-y-6">
        
        <div class="report-card p-6 flex justify-between items-center border-l-8 border-green-500">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">CERTIFIKÁT BATERIE</h2>
                <p class="text-gray-500 text-sm">Vygenerováno z dat Car Scanner</p>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-400">DATUM MĚŘENÍ</div>
                <div id="reportDate" class="font-semibold text-lg">--.--.----</div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="report-card p-8 flex flex-col items-center justify-center col-span-1">
                <h3 class="text-gray-500 font-semibold mb-4 text-center">STATE OF HEALTH (SoH)</h3>
                <div class="gauge-circle" id="sohGauge">
                    <div class="gauge-inner">
                        <span id="sohValue" class="text-4xl font-bold text-gray-800">--%</span>
                        <span class="text-xs text-gray-400">ODHADOVANÉ</span>
                    </div>
                </div>
                <p class="mt-4 text-center text-sm text-gray-500">
                    Na základě imbalance článků<br>
                    <span id="healthStatus" class="font-bold text-green-600">V pořádku</span>
                </p>
            </div>

            <div class="report-card p-6 col-span-2">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Analýza Článků (Cell Analysis)</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-sm text-gray-400">Maximální odchylka (Delta)</div>
                        <div id="maxDelta" class="text-2xl font-bold text-gray-800">-- mV</div>
                        <div class="text-xs text-gray-500">Kritická hodnota > 30mV</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-400">Průměrné napětí článku</div>
                        <div id="avgVoltage" class="text-2xl font-bold text-gray-800">-- V</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-400">Minimální článek</div>
                        <div id="minCellVal" class="text-lg font-semibold text-red-500">-- V</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-400">Maximální článek</div>
                        <div id="maxCellVal" class="text-lg font-semibold text-green-500">-- V</div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Celkové napětí baterie (Avg):</span>
                        <span id="totalVoltage" class="font-bold">-- V</span>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-gray-600">Počet měřených článků:</span>
                        <span id="cellCount" class="font-bold">--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="report-card p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Průběh napětí článků (Min vs Max)</h3>
            <div class="h-64">
                <canvas id="voltageChart"></canvas>
            </div>
        </div>

    </div>

    <script>
        document.getElementById('file_input').addEventListener('change', handleFileSelect, false);

        function handleFileSelect(evt) {
            const file = evt.target.files[0];
            if (!file) return;

            document.getElementById('loading').classList.remove('hidden');

            Papa.parse(file, {
                header: true,
                delimiter: ";", // Car scanner používá středník
                skipEmptyLines: true,
                complete: function(results) {
                    processData(results.data);
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('uploadSection').classList.add('hidden');
                    document.getElementById('reportSection').classList.remove('hidden');
                }
            });
        }

        function processData(data) {
            // 1. Identifikace článků
            let cellData = {}; // { 'Cell 01': [3.62, 3.61...], ... }
            let timestamps = [];
            let uniqueTimestamps = new Set();
            
            // Projít řádky
            data.forEach(row => {
                let pid = row['PID'];
                let val = parseFloat(row['VALUE']);
                let time = parseFloat(row['SECONDS']);

                // Hledáme PIDs začínající na "[BMS] Cell Voltage" nebo podobné
                if (pid && pid.includes('Cell Voltage') && !isNaN(val)) {
                    if (!cellData[pid]) {
                        cellData[pid] = [];
                    }
                    cellData[pid].push({ t: time, v: val });
                    uniqueTimestamps.add(time);
                }
            });

            // Seřadit časy
            let sortedTimes = Array.from(uniqueTimestamps).sort((a, b) => a - b);

            // 2. Agregace dat pro statistiky
            let allVoltages = [];
            let maxDelta = 0;
            let currentSum = 0;
            let count = 0;

            // Pro graf potřebujeme Min a Max napětí v každém čase
            let chartDataMin = [];
            let chartDataMax = [];
            
            // Protože CarScanner je "long format", musíme to trochu odhadnout.
            // Vezmeme všechny hodnoty ze všech článků a najdeme absolutní min/max v celém datasetu
            // Pro přesnější graf by to chtělo seskupit podle času, ale časy se mohou mírně lišit.
            
            // Zjednodušená logika: Projdeme všechny naměřené hodnoty článků
            for (let key in cellData) {
                let values = cellData[key].map(i => i.v);
                allVoltages.push(...values);
            }

            if (allVoltages.length === 0) {
                alert("V CSV nebyly nalezeny žádné záznamy '[BMS] Cell Voltage'!");
                return;
            }

            let absoluteMin = Math.min(...allVoltages);
            let absoluteMax = Math.max(...allVoltages);
            let avgVol = allVoltages.reduce((a, b) => a + b, 0) / allVoltages.length;
            
            // Výpočet delty (přibližný - bere absolutní rozdíl v celém souboru, 
            // správně by to mělo být "max delta v jednom časovém okamžiku", ale pro demo stačí)
            // Uděláme to chytřeji: seskupíme podle času (zaokrouhleno na sekundy)
            let timeGrouped = {};
            data.forEach(row => {
                let pid = row['PID'];
                if (pid && pid.includes('Cell Voltage')) {
                    let t = Math.round(parseFloat(row['SECONDS'])); // Round na sekundy
                    if (!timeGrouped[t]) timeGrouped[t] = [];
                    timeGrouped[t].push(parseFloat(row['VALUE']));
                }
            });

            let deltas = [];
            let timeLabels = [];
            let minSerie = [];
            let maxSerie = [];

            // Seřadíme klíče (časy)
            Object.keys(timeGrouped).sort((a,b)=>a-b).forEach(t => {
                let vals = timeGrouped[t];
                if (vals.length > 5) { // Ignorujeme nekompletní skeny (pokud auto má 96 článků, pár jich může chybět, ale ne moc)
                    let min = Math.min(...vals);
                    let max = Math.max(...vals);
                    let delta = max - min;
                    deltas.push(delta);
                    
                    timeLabels.push(t + "s");
                    minSerie.push(min);
                    maxSerie.push(max);
                }
            });

            let finalMaxDelta = Math.max(...deltas);
            
            // 3. Vykreslení do HTML
            document.getElementById('reportDate').innerText = new Date().toLocaleDateString('cs-CZ');
            document.getElementById('cellCount').innerText = Object.keys(cellData).length;
            document.getElementById('maxDelta').innerText = (finalMaxDelta * 1000).toFixed(1) + " mV"; // Převod na mV
            document.getElementById('avgVoltage').innerText = avgVol.toFixed(3) + " V";
            document.getElementById('minCellVal').innerText = absoluteMin.toFixed(3) + " V";
            document.getElementById('maxCellVal').innerText = absoluteMax.toFixed(3) + " V";
            document.getElementById('totalVoltage').innerText = (avgVol * Object.keys(cellData).length).toFixed(1) + " V (est)";

            // SoH Logika (Simulovaná podle Delty)
            // Delta < 20mV = 98-100%, 20-50mV = 90-98%, >50mV = horší
            let sohScore = 100;
            let deltaMv = finalMaxDelta * 1000;
            
            if (deltaMv < 15) sohScore = 99;
            else if (deltaMv < 30) sohScore = 96;
            else if (deltaMv < 50) sohScore = 90;
            else sohScore = 85 - ((deltaMv - 50) / 5);
            
            sohScore = Math.max(0, Math.round(sohScore));

            document.getElementById('sohValue').innerText = sohScore + "%";
            
            // Barva kruhu
            const gauge = document.getElementById('sohGauge');
            let color = '#22c55e'; // Green
            if (sohScore < 90) color = '#eab308'; // Yellow
            if (sohScore < 80) color = '#ef4444'; // Red
            
            gauge.style.background = `conic-gradient(${color} 0% ${sohScore}%, #e5e7eb ${sohScore}% 100%)`;

            if (sohScore < 80) {
                document.getElementById('healthStatus').innerText = "Pozor: Detekována degradace";
                document.getElementById('healthStatus').className = "font-bold text-red-600";
            } else {
                document.getElementById('healthStatus').innerText = "Baterie je v dobré kondici";
                document.getElementById('healthStatus').className = "font-bold text-green-600";
            }

            // 4. Chart.js Graf
            const ctx = document.getElementById('voltageChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: 'Max Cell Voltage',
                            data: maxSerie,
                            borderColor: '#ef4444',
                            borderWidth: 1,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Min Cell Voltage',
                            data: minSerie,
                            borderColor: '#3b82f6',
                            borderWidth: 1,
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            display: true,
                            title: { display: true, text: 'Napětí (V)' }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>