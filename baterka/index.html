<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Battery Health Certificate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');

        :root {
            --primary: #004d40; /* Tmavƒõ zelen√° ala Aviloo */
            --accent: #2e7d32;
            --text-main: #333;
            --text-light: #666;
            --bg-gray: #f5f5f5;
            --a4-width: 210mm;
            --a4-height: 297mm;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: #e0e0e0;
            margin: 0;
            padding: 20px;
            color: var(--text-main);
        }

        /* UI pro nahr√°v√°n√≠ (nebude vidƒõt na tisku) */
        .no-print {
            background: white;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto 30px auto;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .input-group { margin: 10px 0; display: flex; gap: 10px; justify-content: center; }
        input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }

        /* A4 Str√°nka */
        .page {
            background: white;
            width: var(--a4-width);
            min-height: var(--a4-height);
            margin: 0 auto;
            padding: 40px;
            box-sizing: border-box;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }

        /* Hlaviƒçka */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 20px;
            margin-bottom: 40px;
        }
        .brand h1 { margin: 0; color: var(--primary); text-transform: uppercase; letter-spacing: 2px; font-size: 24px; }
        .brand span { font-size: 12px; color: var(--text-light); text-transform: uppercase; }
        
        .car-info { text-align: right; }
        .car-info h2 { margin: 0; font-size: 18px; }
        .car-info p { margin: 5px 0 0 0; color: var(--text-light); font-size: 14px; }

        /* Hlavn√≠ sekce se sk√≥re */
        .score-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 50px;
        }

        .score-circle {
            position: relative;
            width: 180px;
            height: 180px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
        }
        
        /* Kruhov√Ω graf pomoc√≠ SVG */
        .circular-chart {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            max-height: 250px;
        }
        .circle-bg {
            fill: none;
            stroke: #eee;
            stroke-width: 3.8;
        }
        .circle {
            fill: none;
            stroke-width: 2.8;
            stroke-linecap: round;
            animation: progress 1s ease-out forwards;
        }
        .percentage {
            fill: #666;
            font-family: sans-serif;
            font-weight: bold;
            font-size: 0.5em;
            text-anchor: middle;
        }

        .verdict {
            text-align: center;
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
        }

        /* Tabulka detail≈Ø */
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .detail-box {
            border: 1px solid #eee;
            border-left: 4px solid var(--primary);
            padding: 15px;
            background: #fafafa;
        }
        .detail-label { font-size: 12px; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px; }
        .detail-value { font-size: 24px; font-weight: bold; color: var(--text-main); margin-top: 5px; }
        .detail-sub { font-size: 12px; color: #888; margin-top: 2px; }

        /* Grafy */
        .charts-container {
            margin-top: 30px;
        }
        .chart-wrapper {
            height: 250px;
            margin-bottom: 30px;
            border: 1px solid #eee;
            padding: 10px;
        }
        h3 { font-size: 16px; color: var(--text-main); border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 15px; }

        .footer {
            margin-top: 50px;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            font-size: 10px;
            color: #999;
            text-align: center;
        }

        /* Tiskov√© styly */
        @media print {
            body { background: white; padding: 0; }
            .no-print { display: none !important; }
            .page { box-shadow: none; margin: 0; width: 100%; }
        }
    </style>
</head>
<body>

    <div class="no-print">
        <h2>üõ†Ô∏è Gener√°tor Certifik√°tu</h2>
        <div class="input-group">
            <input type="text" id="inputModel" placeholder="Model vozu (nap≈ô. Kia e-Niro)">
            <input type="text" id="inputVin" placeholder="VIN / SPZ">
        </div>
        <div class="input-group">
            <input type="file" id="csvFile" accept=".csv" style="display: block; margin: 10px auto;">
        </div>
        <p style="font-size: 0.9em; color: #666;">Po naƒçten√≠ dat stisknƒõte <b>CTRL+P</b> pro ulo≈æen√≠ do PDF.</p>
    </div>

    <div class="page" id="reportPage" style="display:none;">
        
        <div class="header">
            <div class="brand">
                <h1>Battery Health Check</h1>
                <span>Independent Analysis Report</span>
            </div>
            <div class="car-info">
                <h2 id="displayModel">Unknown Vehicle</h2>
                <p id="displayVin">VIN: ---</p>
                <p id="displayDate">Datum: --</p>
            </div>
        </div>

        <div class="score-section">
            <div style="flex: 1; padding-right: 40px;">
                <h3 style="border:none; font-size: 20px;">Celkov√© Hodnocen√≠</h3>
                <p style="color: #666; line-height: 1.6;">
                    Tento certifik√°t potvrzuje aktu√°ln√≠ stav trakƒçn√≠ baterie na z√°kladƒõ dat z BMS.
                    Hodnota SoH (State of Health) reprezentuje zb√Ωvaj√≠c√≠ kapacitu baterie oproti nov√©mu stavu.
                </p>
                <div class="detail-box" style="margin-top: 20px;">
                    <div class="detail-label">Status Baterie</div>
                    <div class="detail-value" id="statusText" style="color: green">V√ùBORN√ù</div>
                </div>
            </div>

            <div style="flex: 0 0 200px; text-align: center;">
                <svg viewBox="0 0 36 36" class="circular-chart">
                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <path class="circle" id="sohCirclePath" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" stroke="#4CC790" />
                    <text x="18" y="20.35" class="percentage" id="sohPercentage">--%</text>
                </svg>
                <div style="font-size: 12px; color: #999; margin-top: -10px;">STATE OF HEALTH</div>
            </div>
        </div>

        <h3>Technick√° Anal√Ωza ƒål√°nk≈Ø</h3>
        <div class="details-grid">
            <div class="detail-box">
                <div class="detail-label">Rovnov√°ha ƒål√°nk≈Ø (Delta)</div>
                <div class="detail-value" id="deltaVal">-- mV</div>
                <div class="detail-sub">Max. rozd√≠l mezi nejsilnƒõj≈°√≠m a nejslab≈°√≠m ƒçl√°nkem.</div>
            </div>
            <div class="detail-box">
                <div class="detail-label">Testovan√Ω Rozsah</div>
                <div class="detail-value" id="socRange">-- %</div>
                <div class="detail-sub">Rozsah vybit√≠ bƒõhem testu (SoC).</div>
            </div>
            <div class="detail-box">
                <div class="detail-label">Teplota Baterie</div>
                <div class="detail-value" id="tempRange">-- ¬∞C</div>
                <div class="detail-sub">Min / Max teplota bƒõhem mƒõ≈ôen√≠.</div>
            </div>
            <div class="detail-box">
                <div class="detail-label">Poƒçet mƒõ≈ôen√Ωch ƒçl√°nk≈Ø</div>
                <div class="detail-value">98</div>
                <div class="detail-sub">Detekov√°no z BMS dat.</div>
            </div>
        </div>

        <h3>Grafick√° Vizualizace</h3>
        <div class="charts-container">
            <div class="chart-wrapper">
                <canvas id="voltageChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <canvas id="cell deviation"></canvas>
            </div>
        </div>

        <div class="footer">
            Generated via Car Scanner Data Analysis Tool ‚Ä¢ Not an official manufacturer document.
        </div>
    </div>

<script>
    // Nastaven√≠ PIDs
    const PIDS = {
        SOH: '[BMS] State of Health',
        SOC: '[BMS] State of Charge BMS', 
        TEMP_MIN: '[BMS] Battery Min Temperature',
        TEMP_MAX: '[BMS] Battery Max Temperature',
    };

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        Papa.parse(file, {
            delimiter: ";", 
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function(results) {
                generateCertificate(results.data);
            }
        });
    });

    function generateCertificate(rawData) {
        // Zobrazit str√°nku
        document.getElementById('reportPage').style.display = 'block';

        // Vyplnit hlaviƒçku
        const date = new Date();
        document.getElementById('displayDate').innerText = "Datum: " + date.toLocaleDateString();
        const model = document.getElementById('inputModel').value;
        const vin = document.getElementById('inputVin').value;
        if(model) document.getElementById('displayModel').innerText = model;
        if(vin) document.getElementById('displayVin').innerText = "VIN/ID: " + vin;

        // --- Zpracov√°n√≠ dat (Stejn√° logika jako p≈ôedt√≠m, jen zjednodu≈°en√° pro report) ---
        let timeMap = new Map();
        let lastValues = {};
        
        rawData.sort((a, b) => a.SECONDS - b.SECONDS);
        rawData.forEach(row => {
            const timeKey = Math.floor(row.SECONDS);
            lastValues[row.PID] = row.VALUE;
            timeMap.set(timeKey, { ...lastValues, time: timeKey });
        });
        const timeline = Array.from(timeMap.values());

        // Anal√Ωza
        let maxDelta = 0;
        let soh = 0;
        let startSoc = null, endSoc = null;
        let tMin = 100, tMax = -100;

        const labels = [];
        const minVolts = [];
        const maxVolts = [];
        
        // Pro sloupcov√Ω graf (Cell Deviation)
        let cellVoltagesSnapshot = []; 

        timeline.forEach((point, idx) => {
            // Delta Voltage
            let cells = [];
            for (let i = 1; i <= 98; i++) {
                let pid = `[BMS] Cell Voltage ${i.toString().padStart(2, '0')}`;
                if (point[pid] !== undefined) cells.push(point[pid]);
            }

            if (cells.length > 0) {
                let min = Math.min(...cells);
                let max = Math.max(...cells);
                let delta = max - min;
                
                if (delta > maxDelta) {
                    maxDelta = delta;
                    cellVoltagesSnapshot = cells; // Ulo≈æ√≠me si nejhor≈°√≠ moment
                }
                
                labels.push(idx); // Zjednodu≈°en√° osa X
                minVolts.push(min);
                maxVolts.push(max);
            }

            // Ostatn√≠ metriky
            if (point[PIDS.SOH]) soh = point[PIDS.SOH];
            if (point[PIDS.SOC]) {
                if (startSoc === null) startSoc = point[PIDS.SOC];
                endSoc = point[PIDS.SOC];
            }
            if (point[PIDS.TEMP_MIN]) tMin = Math.min(tMin, point[PIDS.TEMP_MIN]);
            if (point[PIDS.TEMP_MAX]) tMax = Math.max(tMax, point[PIDS.TEMP_MAX]);
        });

        // --- Vyplnƒõn√≠ HTML ---
        
        // 1. SoH Kruh
        const sohValue = soh || 0;
        document.getElementById('sohPercentage').innerText = sohValue + "%";
        // Nastaven√≠ barvy a d√©lky kruhu
        const circlePath = document.getElementById('sohCirclePath');
        const color = sohValue >= 94 ? '#2e7d32' : (sohValue >= 80 ? '#fdd835' : '#c62828');
        circlePath.setAttribute('stroke', color);
        circlePath.setAttribute('stroke-dasharray', `${sohValue}, 100`);
        
        // Slovn√≠ hodnocen√≠
        const statusEl = document.getElementById('statusText');
        if (sohValue >= 94) { statusEl.innerText = "V√ùBORN√ù"; statusEl.style.color = "#2e7d32"; }
        else if (sohValue >= 85) { statusEl.innerText = "DOBR√ù"; statusEl.style.color = "#f9a825"; }
        else { statusEl.innerText = "POZOR / SN√ç≈ΩEN√Å KAPACITA"; statusEl.style.color = "#c62828"; }

        // 2. Detaily
        document.getElementById('deltaVal').innerText = (maxDelta * 1000).toFixed(1) + " mV";
        document.getElementById('socRange').innerText = `${startSoc}% ‚ûî ${endSoc}%`;
        document.getElementById('tempRange').innerText = `${tMin}¬∞C / ${tMax}¬∞C`;

        // 3. Grafy (Chart.js)
        
        // Line chart - Min/Max napƒõt√≠
        new Chart(document.getElementById('voltageChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Max ƒål√°nek', data: maxVolts, borderColor: '#c62828', borderWidth: 1, pointRadius: 0, fill: false },
                    { label: 'Min ƒål√°nek', data: minVolts, borderColor: '#1565c0', borderWidth: 1, pointRadius: 0, fill: '-1', backgroundColor: 'rgba(21, 101, 192, 0.1)' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: true }, title: { display: true, text: 'Rozptyl napƒõt√≠ ƒçl√°nk≈Ø v ƒçase' } },
                scales: { x: { display: false }, y: { title: { display: true, text: 'Volty (V)' } } }
            }
        });

        // Bar chart - Snapshot
        // Pokud nem√°me snapshot (kr√°tk√Ω log), vezmeme posledn√≠ zn√°m√Ω
        if (cellVoltagesSnapshot.length === 0) cellVoltagesSnapshot = new Array(98).fill(0);
        
        // Najdeme pr≈Ømƒõr pro vizu√°ln√≠ osu
        const avgV = cellVoltagesSnapshot.reduce((a,b)=>a+b,0) / cellVoltagesSnapshot.length;

        new Chart(document.getElementById('cell deviation'), {
            type: 'bar',
            data: {
                labels: cellVoltagesSnapshot.map((_, i) => i+1),
                datasets: [{
                    label: 'Napƒõt√≠ ƒçl√°nku (V)',
                    data: cellVoltagesSnapshot,
                    backgroundColor: (ctx) => {
                        const v = ctx.raw;
                        const min = Math.min(...cellVoltagesSnapshot);
                        return v === min ? '#c62828' : '#2e7d32'; // Nejslab≈°√≠ ƒçervenƒõ
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, title: { display: true, text: `Detail ƒçl√°nk≈Ø p≈ôi nejvƒõt≈°√≠ z√°tƒõ≈æi (Max Delta: ${(maxDelta*1000).toFixed(1)} mV)` } },
                scales: { 
                    y: { min: avgV - 0.05, max: avgV + 0.05 } // Zoom na relevantn√≠ oblast
                }
            }
        });
    }
</script>
</body>
</html>