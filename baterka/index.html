<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Battery Certification Report - Professional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');

        :root {
            --primary: #004d40;
            --secondary: #00695c;
            --accent: #ffeb3b;
            --danger: #d32f2f;
            --success: #2e7d32;
            --text: #263238;
            --bg-gray: #eceff1;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-gray); color: var(--text); margin: 0; padding: 20px; }

        /* --- TISK A STR√ÅNKA --- */
        .page {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 15mm;
            box-sizing: border-box;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            position: relative;
        }

        /* --- NO PRINT UI --- */
        .no-print {
            background: #fff; max-width: 800px; margin: 0 auto 30px; padding: 30px;
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center;
        }
        .btn-upload {
            background: var(--primary); color: white; padding: 12px 25px; border-radius: 6px;
            cursor: pointer; font-weight: 600; display: inline-block; margin-top: 10px;
        }
        input[type="text"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }

        /* --- HEADER --- */
        .header { display: flex; justify-content: space-between; border-bottom: 3px solid var(--primary); padding-bottom: 20px; margin-bottom: 30px; }
        .logo h1 { margin: 0; font-size: 28px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .logo span { font-size: 11px; color: #78909c; letter-spacing: 3px; text-transform: uppercase; }
        .meta-data { text-align: right; font-size: 12px; color: #546e7a; }
        .meta-data strong { color: var(--text); font-size: 14px; display: block; margin-bottom: 4px; }

        /* --- SOH HERO SECTION --- */
        .hero-grid { display: grid; grid-template-columns: 2fr 3fr; gap: 30px; margin-bottom: 40px; align-items: center; }
        
        .soh-container { position: relative; text-align: center; }
        .circular-chart { display: block; margin: 0 auto; max-width: 180px; max-height: 180px; }
        .circle-bg { fill: none; stroke: #eee; stroke-width: 2.5; }
        .circle { fill: none; stroke-width: 2.5; stroke-linecap: round; transition: stroke-dasharray 1s ease; }
        .percentage { fill: #37474f; font-family: 'Inter', sans-serif; font-weight: bold; font-size: 0.55em; text-anchor: middle; }
        .soh-label { font-size: 14px; color: #78909c; margin-top: -15px; font-weight: 600; }

        .verdict-box { background: #f1f8e9; padding: 20px; border-left: 5px solid var(--success); border-radius: 4px; }
        .verdict-title { font-size: 12px; text-transform: uppercase; color: #558b2f; font-weight: bold; }
        .verdict-value { font-size: 24px; font-weight: 800; margin: 5px 0; color: var(--primary); }
        .verdict-desc { font-size: 13px; color: #546e7a; line-height: 1.5; }

        /* --- DATA GRID (HISTORY) --- */
        .section-title { font-size: 16px; font-weight: 700; color: var(--text); border-bottom: 1px solid #cfd8dc; padding-bottom: 8px; margin: 30px 0 15px 0; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: #fafafa; padding: 12px; border: 1px solid #eee; border-radius: 6px; }
        .stat-label { font-size: 11px; color: #78909c; text-transform: uppercase; font-weight: 600; margin-bottom: 5px; }
        .stat-value { font-size: 16px; font-weight: 700; color: var(--text); }
        .stat-sub { font-size: 10px; color: #b0bec5; margin-top: 3px; }

        /* --- CHARTS --- */
        .chart-wrapper { border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 25px; page-break-inside: avoid; }
        .chart-desc { font-size: 11px; color: #546e7a; margin-top: 10px; font-style: italic; background: #fffbe6; padding: 8px; border-radius: 4px; }

        /* --- FOOTER --- */
        .footer { margin-top: 40px; border-top: 1px solid #eee; padding-top: 15px; font-size: 10px; color: #b0bec5; text-align: center; }

        @media print {
            body { background: white; padding: 0; }
            .no-print { display: none !important; }
            .page { box-shadow: none; margin: 0; width: 100%; height: auto; }
        }
    </style>
</head>
<body>

    <div class="no-print">
        <h2 style="color:var(--primary)">‚ö° Gener√°tor EV Diagnostiky</h2>
        <div style="margin-bottom: 15px;">
            <input type="text" id="carModel" placeholder="Model (nap≈ô. VW ID.3)">
            <input type="text" id="carVin" placeholder="VIN Vozidla">
        </div>
        <label class="btn-upload">
            üìÇ Nahr√°t CSV z Car Scanner
            <input type="file" id="csvFile" accept=".csv" style="display: none;">
        </label>
        <p style="font-size: 12px; color: #888;">Pro ulo≈æen√≠ stisknƒõte CTRL+P a zvolte "Ulo≈æit jako PDF".</p>
    </div>

    <div class="page" id="reportPage" style="display: none;">
        <div class="header">
            <div class="logo">
                <h1>Battery Report</h1>
                <span>Advanced Cell Analysis</span>
            </div>
            <div class="meta-data">
                <strong id="dispModel">Unknown Model</strong>
                <span id="dispVin">VIN: ---</span>
                <span id="dispDate">Datum: ---</span>
            </div>
        </div>

        <div class="hero-grid">
            <div class="soh-container">
                <svg viewBox="0 0 36 36" class="circular-chart">
                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <path class="circle" id="sohPath" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" stroke="#2e7d32" />
                    <text x="18" y="20.35" class="percentage" id="sohText">--%</text>
                </svg>
                <div class="soh-label">STATE OF HEALTH (SOH)</div>
            </div>
            
            <div class="verdict-box" id="verdictBox">
                <div class="verdict-title">Z√°vƒõr diagnostiky</div>
                <div class="verdict-value" id="verdictText">ANALYZUJI...</div>
                <div class="verdict-desc">
                    SOH reprezentuje zb√Ωvaj√≠c√≠ kapacitu baterie. <br>
                    <span id="sohComment">Hodnota je naƒçtena z BMS syst√©mu vozidla.</span>
                </div>
            </div>
        </div>

        <div class="section-title">HISTORIE A ZDRAV√ç BATERIE (Kl√≠ƒçov√© pro ojet√° vozidla)</div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Pomƒõr Nab√≠jen√≠ (AC/DC)</div>
                <div class="stat-value" id="chargeRatio">-- / --</div>
                <div class="stat-sub">ƒå√≠m v√≠ce AC (pomal√©), t√≠m l√©pe.</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Celkem Nabito</div>
                <div class="stat-value" id="totalEnergy">-- MWh</div>
                <div class="stat-sub">Celo≈æivotn√≠ energie.</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Izolaƒçn√≠ Odpor</div>
                <div class="stat-value" id="isolationRes">-- kŒ©</div>
                <div class="stat-sub">Bezpeƒçnost HV syst√©mu.</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Max. ƒål√°nkov√° Delta</div>
                <div class="stat-value" id="maxDelta">-- mV</div>
                <div class="stat-sub">Rovnov√°ha (ƒç√≠m m√©nƒõ, t√≠m l√©pe).</div>
            </div>
        </div>

        <div class="section-title">DETAILN√ç ANAL√ùZA ƒåL√ÅNK≈Æ (Balanƒçn√≠ test)</div>
        <div class="chart-wrapper">
            <canvas id="deviationChart" height="100"></canvas>
            <div class="chart-desc">
                ‚ÑπÔ∏è <b>Jak ƒç√≠st tento graf:</b> Nulov√° osa p≈ôedstavuje pr≈Ømƒõrn√© napƒõt√≠ v≈°ech ƒçl√°nk≈Ø. Sloupce ukazuj√≠ odchylku jednotliv√Ωch ƒçl√°nk≈Ø v milivoltech (mV). 
                Vysok√© odchylky (zejm√©na ƒçerven√© sloupce smƒõrem dol≈Ø) znaƒç√≠ degradovan√© ƒçl√°nky, kter√© omezuj√≠ dojezd cel√©ho auta.
            </div>
        </div>

        <div class="section-title">PR≈ÆBƒöH TESTU (Z√°tƒõ≈æov√° zkou≈°ka)</div>
        <div class="chart-wrapper">
            <canvas id="timelineChart" height="80"></canvas>
            <div class="chart-desc">
                ‚ÑπÔ∏è <b>≈†ed√° z√≥na:</b> Rozd√≠l mezi nejsilnƒõj≈°√≠m a nejslab≈°√≠m ƒçl√°nkem bƒõhem j√≠zdy. Pokud se z√≥na p≈ôi zrychlen√≠ v√Ωraznƒõ roz≈°i≈ôuje ("trycht√Ω≈ô"), baterie m√° mƒõkk√©/vadn√© ƒçl√°nky.
            </div>
        </div>

        <div class="footer">
            Generated via Car Scanner Data Analyzer ‚Ä¢ Data processing by Browser AI ‚Ä¢ Not an official manufacturer certificate.
        </div>
    </div>

    <script>
        // --- KONFIGURACE PID≈Æ ---
        const PIDS = {
            SOH: ['[BMS] State of Health', 'State of Health'],
            SOC: ['[BMS] State of Charge BMS', '[BMS] State of Charge Display', 'State of Charge'],
            TOTAL_CHARGE: ['[BMS] Cumulative Energy Charged', 'Cumulative Energy Charged'],
            TOTAL_DISCHARGE: ['[BMS] Cumulative Energy Discharged'],
            AC_ENERGY: ['[BMS] Accumulated normal charging energy'],
            DC_ENERGY: ['[BMS] Accumulated quick charging energy'],
            ISOLATION: ['[BMS] Isolation Resistance'],
            OP_TIME: ['[BMS] Operating Time', '[BMS] Battery work time total (h)'],
            CELL_PREFIX: '[BMS] Cell Voltage'
        };

        // Pomocn√° funkce pro hled√°n√≠ PIDu (nƒõkter√° auta maj√≠ r≈Øzn√© n√°zvy)
        function findVal(row, pidArray) {
            if(!Array.isArray(pidArray)) pidArray = [pidArray];
            for (let pid of pidArray) {
                if (row[pid] !== undefined && row[pid] !== null && row[pid] !== "") return row[pid];
            }
            return null;
        }

        document.getElementById('csvFile').addEventListener('change', (e) => {
            Papa.parse(e.target.files[0], {
                delimiter: ";", header: true, dynamicTyping: true, skipEmptyLines: true,
                complete: (results) => processData(results.data)
            });
        });

        function processData(rawData) {
            document.getElementById('reportPage').style.display = 'block';
            document.querySelector('.no-print').style.display = 'none'; // Schovat nahr√°v√°n√≠
            
            // Meta data
            document.getElementById('dispDate').innerText = "Datum: " + new Date().toLocaleDateString();
            if(document.getElementById('carModel').value) document.getElementById('dispModel').innerText = document.getElementById('carModel').value;
            if(document.getElementById('carVin').value) document.getElementById('dispVin').innerText = "VIN: " + document.getElementById('carVin').value;

            // 1. P≈ò√çPRAVA DAT (Time grouping)
            let timeMap = new Map();
            let lastVals = {};
            rawData.sort((a,b) => a.SECONDS - b.SECONDS);
            
            // Scan for static/accumulated values first (SOH, Total Energy)
            let maxSoh = 0;
            let finalAc = 0, finalDc = 0, finalTotalE = 0, isolation = 0;

            rawData.forEach(row => {
                // SOH Logic: Find the last non-zero SOH
                let s = findVal(row, PIDS.SOH);
                if (s > 0) maxSoh = s;

                // Energy Logic
                let ac = findVal(row, PIDS.AC_ENERGY);
                if (ac > finalAc) finalAc = ac;
                
                let dc = findVal(row, PIDS.DC_ENERGY);
                if (dc > finalDc) finalDc = dc;

                let tot = findVal(row, PIDS.TOTAL_CHARGE);
                if (tot > finalTotalE) finalTotalE = tot;

                let iso = findVal(row, PIDS.ISOLATION);
                if (iso > 0) isolation = iso; // Usually static

                // Time mapping
                const t = Math.floor(row.SECONDS);
                lastVals[row.PID] = row.VALUE;
                timeMap.set(t, { ...lastVals, time: t });
            });

            // 2. ANAL√ùZA ƒåL√ÅNK≈Æ
            const timeline = Array.from(timeMap.values());
            let maxDelta = 0;
            let worstSnapshot = null;
            
            // Grafy Arrays
            const labels = [];
            const minArr = [], maxArr = [], avgArr = [];

            timeline.forEach((pt, idx) => {
                let cells = [];
                for(let i=1; i<=98; i++) {
                    let key = `${PIDS.CELL_PREFIX} ${i.toString().padStart(2,'0')}`;
                    if(pt[key] !== undefined) cells.push(pt[key]);
                }

                if(cells.length > 0) {
                    let min = Math.min(...cells);
                    let max = Math.max(...cells);
                    let avg = cells.reduce((a,b)=>a+b,0)/cells.length;
                    let delta = max - min;

                    if(delta > maxDelta) {
                        maxDelta = delta;
                        worstSnapshot = { cells, avg }; // Ulo≈æit data pro bar chart
                    }

                    // Jen ka≈æd√Ω X-t√Ω bod pro graf, aby nebyl p≈ôeplnƒõn√Ω
                    if(idx % 5 === 0 || delta === maxDelta) {
                        labels.push(idx); // ƒåasov√° osa
                        minArr.push(min);
                        maxArr.push(max);
                        avgArr.push(avg);
                    }
                }
            });

            // 3. VYKRESLEN√ç HODNOT

            // SOH Visuals
            const sohDisp = maxSoh > 0 ? maxSoh : "N/A";
            document.getElementById('sohText').innerText = sohDisp + (maxSoh > 0 ? "%" : "");
            
            let color = '#2e7d32'; // Green
            let verdict = "V√ùBORN√ù STAV";
            let desc = "Baterie vykazuje kapacitu bl√≠zkou nov√©. ≈Ω√°dn√© anom√°lie.";

            if (maxSoh > 0 && maxSoh < 90) { color = '#fbc02d'; verdict = "DOBR√ù STAV"; desc = "Bƒõ≈æn√© opot≈ôeben√≠ odpov√≠daj√≠c√≠ st√°≈ô√≠."; }
            if (maxSoh > 0 && maxSoh < 75) { color = '#c62828'; verdict = "DEGRADOVAN√Å"; desc = "Kapacita je v√Ωraznƒõ sn√≠≈æena. Doporuƒçena kontrola."; }
            
            document.getElementById('sohPath').setAttribute('stroke', color);
            document.getElementById('sohPath').setAttribute('stroke-dasharray', `${maxSoh}, 100`);
            document.getElementById('verdictText').innerText = verdict;
            document.getElementById('verdictText').style.color = color;
            document.querySelector('.verdict-box').style.borderLeftColor = color;
            document.getElementById('sohComment').innerHTML = desc;

            // Stats
            document.getElementById('maxDelta').innerText = (maxDelta * 1000).toFixed(1) + " mV";
            document.getElementById('isolationRes').innerText = isolation > 0 ? isolation + " kŒ©" : "Nezmƒõ≈ôeno";
            
            // Energy & Ratio
            if (finalAc > 0 || finalDc > 0) {
                // P≈ôevod na MWh nebo kWh
                const total = finalAc + finalDc;
                const acPerc = ((finalAc / total) * 100).toFixed(0);
                const dcPerc = ((finalDc / total) * 100).toFixed(0);
                
                document.getElementById('chargeRatio').innerHTML = 
                    `<span style="color:${color}">AC: ${acPerc}%</span> / <span style="color:#d32f2f">DC: ${dcPerc}%</span>`;
                
                // Zkus√≠me naj√≠t celkovou, pokud nen√≠, seƒçteme
                let eVal = finalTotalE > 0 ? finalTotalE : total;
                let unit = "kWh";
                if(eVal > 10000) { eVal = eVal / 1000; unit = "MWh"; }
                document.getElementById('totalEnergy').innerText = eVal.toFixed(1) + " " + unit;
            }

            // 4. VYKRESLEN√ç GRAF≈Æ

            // A) Deviation Chart (AVILOO style)
            // Zobrazuje odchylku od PR≈ÆMƒöRU v momentƒõ nejvƒõt≈°√≠ delty
            if (worstSnapshot) {
                const deviationData = worstSnapshot.cells.map(v => (v - worstSnapshot.avg) * 1000); // v mV
                const devLabels = worstSnapshot.cells.map((_, i) => i + 1);
                
                new Chart(document.getElementById('deviationChart'), {
                    type: 'bar',
                    data: {
                        labels: devLabels,
                        datasets: [{
                            label: 'Odchylka od pr≈Ømƒõru (mV)',
                            data: deviationData,
                            backgroundColor: deviationData.map(v => v < -10 ? '#d32f2f' : (v > 10 ? '#fbc02d' : '#2e7d32')),
                            borderRadius: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { title: { display: true, text: 'Odchylka (mV)' } },
                            x: { title: { display: true, text: 'ƒå√≠slo ƒçl√°nku' }, grid: { display: false } }
                        }
                    }
                });
            }

            // B) Timeline Chart
            new Chart(document.getElementById('timelineChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Max ƒål√°nek', data: maxArr, borderColor: '#d32f2f', borderWidth: 1, pointRadius: 0, fill: false },
                        { label: 'Pr≈Ømƒõr', data: avgArr, borderColor: '#333', borderWidth: 1, borderDash: [5,5], pointRadius: 0, fill: false },
                        { label: 'Min ƒål√°nek', data: minArr, borderColor: '#1976d2', borderWidth: 1, pointRadius: 0, fill: '-1', backgroundColor: 'rgba(200, 200, 200, 0.3)' }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { title: { display: true, text: 'Napƒõt√≠ (V)' } }, x: { display: false } }
                }
            });
        }
    </script>
</body>
</html>